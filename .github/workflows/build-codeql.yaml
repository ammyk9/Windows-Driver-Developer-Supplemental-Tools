# Continuous integration action for the CodeQL components of this repo.
# This downloads the CodeQL CLI and then builds all the queries in the "windows-drivers" folder.

name: Build Windows CodeQL queries

on:
  # Triggers the workflow on push or pull request events but only for the main and development branches
  push:
    branches: [ main, development, jacob-ronstadt/script_updates ]
  pull_request:
    branches: [ main, development ]

  # Allow manual scheduling
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest

    steps:
    - name: Enable long git paths
      shell: cmd
      run: git config --global core.longpaths true
    
    - name: Clone self (windows-driver-developer-supplemental-tools)
      uses: actions/checkout@v2
      with:
        path: .
    
    - name: Setup CodeQL 
      uses: github/codeql-action/init@v3
      with:
        db-location: '${{ github.runner_temp }}/result_db'

    - name: Setup Python
      uses: actions/setup-python@v2
      with:
        python-version: 3.11
    - name: Install Python Packages
      run: |
          python -m pip install --upgrade pip
          pip install -r .\src\drivers\test\requirements.txt
    - name: Add msbuild to PATH
      uses: microsoft/setup-msbuild@v2

    - name: Run test script
      shell: cmd
      working-directory: .\src\drivers\test\
      run: python build_create_analyze_test.py
      
    - name: Build must-fix driver suite
      shell: cmd
      run: .\codeql-cli\codeql.cmd query compile --check-only windows_driver_mustfix.qls
    
    - name: Build recommended driver suite
      shell: cmd
      run: .\codeql-cli\codeql.cmd query compile --check-only windows_driver_recommended.qls
    
    - name: Build CA ported queries
      shell: cmd
      run: .\codeql-cli\codeql.cmd query compile --check-only ported_driver_ca_checks.qls
    
    - name: Build all Windows queries
      shell: cmd
      run: .\codeql-cli\codeql.cmd query compile --check-only .\src

   
